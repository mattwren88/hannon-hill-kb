<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Best practices for performance - Cascade CMS Knowledge Base</title>
  <meta name="description" content="When working with choosers, it is important to save repeated .asset calls to a variable and then access that variable&#39;s methods directly. Failure to do so will result in multiple r">
  <script>
  (function () {
    var pref = localStorage.getItem('theme-preference');
    var theme;
    if (pref === 'dark') { theme = 'dark'; }
    else if (pref === 'light') { theme = 'light'; }
    else { theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'; }
    document.documentElement.setAttribute('data-theme', theme);
  })();
  </script>
  <link rel="stylesheet" href="./_assets/css/bundle.min.css">
  <link rel="stylesheet" href="./_assets/css/print.css" media="print">
</head>
<body id="top">
  <a href="#main-content" class="hh-skip-link">Skip to main content</a>
  <header class="hh-header" role="banner">
    <div class="hh-header-left">
      <button class="hh-header-menu-toggle" aria-label="Toggle navigation" aria-expanded="false">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
      </button>
      <a href="./" class="hh-header-logo"><span style="color: var(--color-primary-vivid); font-weight: 700;">Cascade</span>&nbsp;CMS Docs</a>
    </div>
    <nav class="hh-header-nav" aria-label="Top navigation">
      <a href="#" class="hh-header-nav-link hh-header-nav-link-active">Knowledge Base</a>
      <a href="#" class="hh-header-nav-link">Release Notes</a>
      <a href="#" class="hh-header-nav-link">Support</a>
    </nav>
    <div class="hh-header-right">
      <button class="hh-header-search-trigger" aria-label="Search documentation">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        <span class="hh-header-search-text">Search...</span>
        <kbd class="hh-header-search-kbd">âŒ˜K</kbd>
      </button>
      <div class="hh-theme-toggle">
        <button class="hh-theme-toggle-button" aria-label="Toggle color theme" aria-expanded="false" aria-haspopup="true">
          <svg class="hh-theme-toggle-icon hh-theme-toggle-icon-light" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
          <svg class="hh-theme-toggle-icon hh-theme-toggle-icon-dark" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
          <svg class="hh-theme-toggle-icon hh-theme-toggle-icon-system" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
        </button>
        <div class="hh-theme-toggle-dropdown" role="menu" hidden>
          <button class="hh-theme-toggle-option" role="menuitem" data-theme="light">Light</button>
          <button class="hh-theme-toggle-option" role="menuitem" data-theme="dark">Dark</button>
          <button class="hh-theme-toggle-option hh-theme-toggle-option-active" role="menuitem" data-theme="system">System</button>
        </div>
      </div>
    </div>
  </header>

  <div class="hh-sidebar-overlay"></div>
  <div class="hh-docs-layout">
    <aside class="hh-sidebar" aria-label="Documentation navigation">
      <nav class="hh-sidebar-nav">
        <div class="hh-sidebar-section">
  <button class="hh-sidebar-category" aria-expanded="true">
    Script Formats
    <svg class="hh-sidebar-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
  </button>
  <ul class="hh-sidebar-pages">
    <li><a href="./velocity-tools.html" class="hh-sidebar-link">Velocity Tools</a></li>
    <li><a href="./date-tool-essentials.html" class="hh-sidebar-link">Date Tool Essentials</a></li>
    <li><a href="./query-tool-directives.html" class="hh-sidebar-link">Query Tool Directives</a></li>
    <li><a href="./velocity-best-practices.html" class="hh-sidebar-link hh-sidebar-link-active" aria-current="page">Best Practices for Performance</a></li>
  </ul>
</div>
      </nav>
    </aside>

    <main id="main-content" class="hh-main">
      <article class="hh-content">
        <nav class="hh-breadcrumb" aria-label="Breadcrumb">
  <ol class="hh-breadcrumb-list">
    <li class="hh-breadcrumb-item"><a href="./" class="hh-breadcrumb-link">Home</a></li>
    <li class="hh-breadcrumb-item hh-breadcrumb-item-current" aria-current="page">Best Practices for Performance</li>
  </ol>
</nav>
        <header class="hh-content-header">
          <span class="hh-content-category-label">Developing In Cascade</span>
          <h1 class="hh-content-title">Best practices for performance</h1>
        </header>
        <div class="hh-content-body">
<h2 id="developing-in-cascade-script-formats-velocity-best-practices-section-1">Working with choosers</h2>
                        <p>When working with choosers, it is important to save repeated <code>.asset</code> calls to a variable and then access that variable's methods directly. Failure to do so will result in multiple round trips to the database when only a single round trip is necessary.</p>
<p>Consider the following Velocity code which accesses an image file that has been selected in a chooser: </p>
<div class="hh-code-block">
  <div class="hh-code-block-header">
    <span class="hh-code-block-language">Velocity</span>
    <button class="hh-code-block-copy" aria-label="Copy code">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path></svg>
      <span>Copy</span>
    </button>
  </div>
  <pre class="hh-code-block-pre"><code class="language-velocity">#set ($image = $currentPage.getStructuredDataNode("image"))
## one database round trip
#set ($imageLink = $image.asset.link)
## another database round trip
#set ($imageFileSize = $image.asset.fileSize)
## another database round trip
#set ($imageWidth = $image.asset.dimensions.width)
## another database round trip
#set ($imageHeight = $image.asset.dimensions.height)</code></pre>
</div>
<p>As indicated by the comments, each line with <code>.asset</code> is having to fetch the image from the database (forcing a round trip from the app to the database and back). </p>
<p>Rather than doing this, the code can be simplified by saving the chosen asset to a variable and then accessing methods of that variable:</p>
<div class="hh-code-block">
  <div class="hh-code-block-header">
    <span class="hh-code-block-language">Velocity</span>
    <button class="hh-code-block-copy" aria-label="Copy code">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path></svg>
      <span>Copy</span>
    </button>
  </div>
  <pre class="hh-code-block-pre"><code class="language-velocity">## one database round trip
#set ($selectedImage = $currentPage.getStructuredDataNode("image").asset)
#set ($imageLink =$selectedImage.link)
#set ($imageFileSize = $selectedImage.fileSize)
#set ($imageWidth = $selectedImage.dimensions.width)
#set ($imageHeight = $selectedImage.dimensions.height)</code></pre>
</div>
                                    
<h2 id="developing-in-cascade-script-formats-velocity-best-practices-section-2">Importing Formats</h2>
                        <p> <code>#import</code> directives in Formats require a round trip from the app to the database and back again. This is necessary in order for the app to retrieve the contents of the Format being imported at runtime. Due to this fact, it is important to limit the number of <code>#import</code> directives as much as possible in order to keep transformation times performant. </p>
<p>Consider the following sample code snippet below which imports 3 Formats. Each of the imported Formats contains a single macro.</p>
<div class="hh-code-block">
  <div class="hh-code-block-header">
    <span class="hh-code-block-language">Velocity</span>
    <button class="hh-code-block-copy" aria-label="Copy code">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path></svg>
      <span>Copy</span>
    </button>
  </div>
  <pre class="hh-code-block-pre"><code class="language-velocity">## one database round trip
#import ("_cms/formats/shared/macros/stripTags")
## another database round trip
#import ("_cms/formats/shared/macros/escapeAll")
## another database round trip
#import ("_cms/formats/shared/macros/makeAccessible")</code></pre>
</div>
<p>While this type of setup is clean and makes things very straightforward to manage (a single Format contains a single macro with a corresponding name), it requires 3 round trips to the database during the transformation of any Page on which the main Format is attached.</p>
<p>In order to prevent repeated <code>#import</code> calls like this, macros should instead be combined into fewer Formats so that fewer <code>#import</code> directives are needed.</p>
<p>Continuing the example from above, the macros from the 3 separate Formats indicated above can be combined into a single Format (we'll name it <code>utility</code> for the purposes of this sample). Then, rather than importing 3 separate Formats to get access to the 3 individual macros, a single line will do the trick:</p>
<div class="hh-code-block">
  <div class="hh-code-block-header">
    <span class="hh-code-block-language">Velocity</span>
    <button class="hh-code-block-copy" aria-label="Copy code">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path></svg>
      <span>Copy</span>
    </button>
  </div>
  <pre class="hh-code-block-pre"><code class="language-velocity">## one database round trip
#import ("_cms/formats/shared/macros/utility")</code></pre>
</div>
<p>Now, rather than making multiple trips back and forth to the database (adding to overall render times), only one trip is required and the main Format automatically has access to all of the macros needed for the transformation.<code></code></p>
                                    
<h2 id="developing-in-cascade-script-formats-velocity-best-practices-section-3">Using the Query API</h2>
                        <h2>Accessing Structured Data and Dynamic Metadata</h2>
<p>When working with the Query API, if you're accessing Structured Data or Dynamic Metadata fields for the queried assets, you should utilize the corresponding <code>$_.query().preloadStructuredData</code> and/or <code>$_.query().preloadDynamicMetadata</code> methods for a performance boost. </p>
<h3>Preloading Structured Data</h3>
<p>Consider the following code which loads 500 "events":</p>
<div class="hh-code-block">
  <div class="hh-code-block-header">
    <span class="hh-code-block-language">Velocity</span>
    <button class="hh-code-block-copy" aria-label="Copy code">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path></svg>
      <span>Copy</span>
    </button>
  </div>
  <pre class="hh-code-block-pre"><code class="language-velocity">#set ($events = $_.query().byContentType("event").execute())
#foreach ($event in $events)
 ## database round trip (x 500)
 #set($start = $event.getStructuredDataNode("startDateTime").textValue)
 #set($end = $event.getStructuredDataNode("endDateTime").textValue)
 #set($details = $event.getStructuredDataNode("details").textValue)
 #set($link = $event.getStructuredDataNode("additional").getChild("link").textValue)
## additional logic here
#end</code></pre>
</div>
<p>In the <code>foreach</code> loop here, the application will be required to make a database round trip for each of the 500 results in order to gather each asset's Structured Data. </p>
<p>By adding the "preload" method to the query as seen below:</p>
<div class="hh-code-block">
  <div class="hh-code-block-header">
    <span class="hh-code-block-language">Velocity</span>
    <button class="hh-code-block-copy" aria-label="Copy code">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path></svg>
      <span>Copy</span>
    </button>
  </div>
  <pre class="hh-code-block-pre"><code class="language-velocity">#set ($events = $_.query().byContentType("event").preloadStructuredData().execute())</code></pre>
</div>
<p>The initial query execution will take longer (since the application is gathering the related Structured Data for all 500 results upfront), but accessing this data in the <code>foreach</code> loop for each asset will be exponentially faster as the data is already in memory. </p>
<h3>Preloading Dynamic Metadata</h3>
<p>Similar to above, you can preload dynamic metadata as well. Consider the following code in a scenario where the query is returning 500 assets:</p>
<div class="hh-code-block">
  <div class="hh-code-block-header">
    <span class="hh-code-block-language">Velocity</span>
    <button class="hh-code-block-copy" aria-label="Copy code">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path></svg>
      <span>Copy</span>
    </button>
  </div>
  <pre class="hh-code-block-pre"><code class="language-velocity">#set ($events = $_.query().byContentType("event").execute())
#foreach ($event in $events)
 ## database round trip (x 500)
 #set($showInNavMenu = $event.metadata.getDynamicField("display-in-nav").value)
 #set($alternateTitle = $event.metadata.getDynamicField("alternate title").value)
## additional logic here
#end</code></pre>
</div>
<p>In order to increase performance, we can change the query line as follows which will preload the necessary dynamic metadata fields:</p>
<div class="hh-code-block">
  <div class="hh-code-block-header">
    <span class="hh-code-block-language">Velocity</span>
    <button class="hh-code-block-copy" aria-label="Copy code">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path></svg>
      <span>Copy</span>
    </button>
  </div>
  <pre class="hh-code-block-pre"><code class="language-velocity">#set ($events = $_.query().byContentType("event").preloadDynamicMetadata().execute())</code></pre>
</div>
<p>This will force the app to load all of the metadata fields upfront which prevents the repeated database round trips within the <code>foreach</code> loop.</p>
<h2>Leveraging the #queryexecute directive</h2>
<p>The <a href="https://www.hannonhill.com/cascadecms/latest/developing-in-cascade/script-formats/tools/query-api.html#queryexecute"><code>#queryexecute</code></a> directive is an alternative to the <code>.execute()</code> method of the <a href="https://www.hannonhill.com/cascadecms/latest/developing-in-cascade/script-formats/velocity-tools.html#QueryAPI">Query API</a>. The main benefits of using this directive are as follows:</p>
<ul>
<li>It bypasses the 2,000 asset limitation of the <code>.execute()</code> method (allowing for querying up to 100,000 assets).</li>
<li>On each iteration, the previous asset in stored in memory is removed from memory to allow for the processing of the remaining assets without hampering performance.</li>
</ul>
        </div>
        <footer class="hh-content-footer">
  <div class="hh-content-meta">
    <span>Last updated: February 22, 2026</span>
  </div>
  <nav class="hh-content-pagination" aria-label="Article navigation">
    <a href="./query-tool-directives.html" class="hh-content-prev"><span>Previous</span><span>Query Tool Directives</span></a>
    
  </nav>
</footer>
      </article>
    </main>

    <aside class="hh-toc" aria-label="Table of contents">
      <div class="hh-toc-sticky">
        <h2 class="hh-toc-title">ON THIS PAGE</h2>
        <nav class="hh-toc-nav"></nav>
      </div>
    </aside>

    <button class="hh-toc-toggle" aria-label="Table of contents" aria-expanded="false">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
    </button>
  </div>

  <footer class="hh-site-footer" role="contentinfo">
  <div class="hh-site-footer-inner">
    <nav class="hh-site-footer-primary" aria-label="Footer primary links">
      <a class="hh-site-footer-primary-link" href="https://www.hannonhill.com/cascadecms/latest/">Documentation Home</a>
      <a class="hh-site-footer-primary-link" href="https://www.hannonhill.com/cascadecms/latest/release-notes/index.html">Release Notes</a>
      <a class="hh-site-footer-primary-link" href="https://support.hannonhill.com/">Support</a>
      <a class="hh-site-footer-primary-link" href="https://www.hannonhill.com/cascadecms/latest/rss/index.html">RSS</a>
    </nav>
    <div class="hh-site-footer-bottom">
      <p class="hh-site-footer-copyright">All content &copy; 2026 Hannon Hill. All rights reserved.</p>
      <nav class="hh-site-footer-links" aria-label="Footer links">
        <a class="hh-site-footer-link" href="https://www.hannonhill.com/about-us">About Us</a>
        <a class="hh-site-footer-link" href="https://www.hannonhill.com/careers">Careers</a>
        <a class="hh-site-footer-link" href="https://www.hannonhill.com/compliance">Compliance</a>
        <a class="hh-site-footer-link" href="https://www.hannonhill.com/resources">Resources</a>
        <a class="hh-site-footer-link" href="https://hannonhill.ideas.aha.io/">Idea Portal</a>
        <a class="hh-site-footer-link" href="https://www.hannonhill.com/site-index">Site Index</a>
        <a class="hh-site-footer-link" href="https://github.com/hannonhill">Github</a>
        <a class="hh-site-footer-link" href="https://www.hannonhill.com/accessibility-policy">Accessibility</a>
        <a class="hh-site-footer-link" href="https://www.hannonhill.com/privacy-policy">Privacy Policy</a>
        <a class="hh-site-footer-link" href="https://www.hannonhill.com/legal">Legal</a>
      </nav>
    </div>
  </div>
</footer>
  <div class="hh-search-overlay" role="dialog" aria-modal="true" aria-label="Search documentation" data-search-index="./search-index.json" hidden>
    <div class="hh-search-overlay-backdrop"></div>
    <div class="hh-search-overlay-dialog">
      <div class="hh-search-overlay-header">
        <svg class="hh-search-overlay-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        <input type="search" class="hh-search-overlay-input" placeholder="Search documentation..." autocomplete="off">
        <kbd class="hh-search-overlay-shortcut">ESC</kbd>
      </div>
      <div class="hh-search-overlay-live" role="status" aria-live="polite" aria-atomic="true" style="position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;"></div>
      <div class="hh-search-overlay-results"><div class="hh-search-overlay-empty">Start typing to search...</div></div>
      <div class="hh-search-overlay-footer"><span>Navigate with <kbd>&uarr;</kbd><kbd>&darr;</kbd></span><span>Open with <kbd>&crarr;</kbd></span></div>
    </div>
  </div>

  <script src="./_assets/vendor/prism/prism.min.js" defer></script>
  <script src="./_assets/vendor/prism/prism-markup.min.js" defer></script>
  <script src="./_assets/vendor/prism/prism-css.min.js" defer></script>
  <script src="./_assets/vendor/prism/prism-javascript.min.js" defer></script>
  <script src="./_assets/vendor/prism/prism-java.min.js" defer></script>
  <script src="./_assets/vendor/prism/prism-python.min.js" defer></script>
  <script src="./_assets/vendor/prism/prism-json.min.js" defer></script>
  <script src="./_assets/vendor/prism/prism-bash.min.js" defer></script>
  <script src="./_assets/vendor/prism/prism-yaml.min.js" defer></script>
  <script src="./_assets/vendor/prism/prism-sql.min.js" defer></script>
  <script src="./_assets/vendor/prism/prism-markup-templating.min.js" defer></script>
  <script src="./_assets/vendor/prism/prism-velocity.min.js" defer></script>
  <script src="./_assets/vendor/lunr/lunr.min.js" defer></script>
  <script src="./_assets/js/theme.js" defer></script>
  <script src="./_assets/js/sidebar.js" defer></script>
  <script src="./_assets/js/toc.js" defer></script>
  <script src="./_assets/js/hh-heading-anchor.js" defer></script>
  <script src="./_assets/js/tabs.js" defer></script>
  <script src="./_assets/js/hh-accordion.js" defer></script>
  <script src="./_assets/js/hh-code-block.js" defer></script>
  <script src="./_assets/js/search.js" defer></script>

  <a href="#top" class="hh-back-to-top" aria-label="Back to top">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <polyline points="18 15 12 9 6 15"></polyline>
    </svg>
  </a>
</body>
</html>